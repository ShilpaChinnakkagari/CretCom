{% extends "base.html" %}

{% block title %}Department Management - CretCom{% endblock %}

{% block navigation %}
    <a href="/principal/dashboard">ğŸ“Š Dashboard</a>
    <a href="/principal/user-management">ğŸ‘¥ User Management</a>
    <a href="/principal/finance-management">ğŸ’° Finance</a>
    <a href="/principal/department-management">ğŸ« Departments</a>
    <a href="/principal/analytics">ğŸ“ˆ Analytics</a>
    <a href="/logout">ğŸšª Logout</a>
{% endblock %}

{% block content %}
<h1>Department Management</h1>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    <!-- CREATE DEPARTMENT -->
    <div style="background: white; padding: 20px; border-radius: 10px;">
        <h3>â• Create New Department</h3>
        <form id="createDepartmentForm">
            <div style="margin-bottom: 15px;">
                <label>Department Name:</label>
                <input type="text" name="name" placeholder="Computer Science, Electronics, etc." required style="width: 100%; padding: 8px; margin-top: 5px;">
            </div>
            <button type="submit" style="width: 100%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Create Department
            </button>
        </form>
    </div>

    <!-- DEPARTMENT STATS -->
    <div style="background: white; padding: 20px; border-radius: 10px;">
        <h3>ğŸ“Š Department Statistics</h3>
        <div style="font-size: 2em; font-weight: bold; color: #2c3e50; margin: 10px 0;">
            {{ departments|length }}
        </div>
        <div style="color: #7f8c8d; margin-bottom: 20px;">Total Departments</div>
        
        <div style="display: grid; gap: 10px;">
            <div style="display: flex; justify-content: space-between;">
                <span>Departments with HOD:</span>
                <strong>{{ departments|selectattr('hod_id')|list|length }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Total Faculty:</span>
                <strong>{{ departments|sum(attribute='faculty_count') }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Total Students:</span>
                <strong>{{ departments|sum(attribute='student_count') }}</strong>
            </div>
        </div>
    </div>
</div>

<!-- EXISTING DEPARTMENTS -->
<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
    <h3>ğŸ« Existing Departments</h3>
    {% if departments %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
        {% for dept in departments %}
        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; color: #2c3e50;">{{ dept.name }}</h4>
                <span style="background: {% if dept.hod_id %}#27ae60{% else %}#e74c3c{% endif %}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                    {% if dept.hod_id %}HOD Assigned{% else %}No HOD{% endif %}
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div>
                    <strong>HOD:</strong><br>
                    {{ dept.hod_name or 'Not Assigned' }}
                </div>
                <div>
                    <strong>Faculty:</strong><br>
                    {{ dept.faculty_count }} members
                </div>
                <div>
                    <strong>Students:</strong><br>
                    {{ dept.student_count }} students
                </div>
                <div>
                    <strong>Status:</strong><br>
                    <span style="color: {% if dept.hod_id %}#27ae60{% else %}#e74c3c{% endif %};">
                        {% if dept.hod_id %}Active{% else %}Inactive{% endif %}
                    </span>
                </div>
            </div>
            
            {% if not dept.hod_id and hods %}
            <div style="margin-top: 10px;">
                <label><strong>Assign HOD:</strong></label>
                <select onchange="assignHOD(this.value, {{ dept.id }})" style="width: 100%; padding: 5px; margin-top: 5px;">
                    <option value="">Select HOD</option>
                    {% for hod in hods %}
                    <option value="{{ hod.id }}">{{ hod.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 20px;">No departments created yet</p>
    {% endif %}
</div>

<script>
// Create Department Form Submission
document.getElementById('createDepartmentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const departmentData = {
        name: formData.get('name')
    };
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = 'â³ Creating...';
    submitBtn.disabled = true;
    
    fetch('/principal/create-department', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(departmentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… Department created successfully!');
            location.reload();
        } else {
            alert('âŒ Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('âŒ Network error: ' + error);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Assign HOD Function
function assignHOD(hodId, departmentId) {
    if (!hodId) return;
    
    if (confirm('Are you sure you want to assign this HOD to the department?')) {
        fetch('/principal/assign-hod', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                department_id: departmentId,
                hod_id: hodId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('âœ… HOD assigned successfully!');
                location.reload();
            } else {
                alert('âŒ Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('âŒ Network error: ' + error);
        });
    }
}
</script>
{% endblock %}