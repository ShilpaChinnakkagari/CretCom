{% extends "base.html" %}

{% block title %}Sections Management - CretCom{% endblock %}

{% block navigation %}
    {% if session.user_role == 'hod' %}
        <a href="/hod/dashboard">📊 Dashboard</a>
        <a href="/hod/faculty">👨‍🏫 Faculty</a>
        <a href="/hod/students">🎓 Students</a>
        <a href="/hod/filter-students">🔍 Filter Students</a>
        <a href="/hod/sections">🏫 Sections</a>
        <a href="/hod/ao-management">👨‍💼 AO Management</a>
        <a href="/logout">🚪 Logout</a>
    {% endif %}
{% endblock %}

{% block content %}
<h1>🏫 Sections & Mentorship Management - {{ department }}</h1>

<!-- SECTION CREATION -->
<div style="background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">➕ Create New Section</h3>
    <form id="addSectionForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <label>Section Name *:</label>
                <input type="text" name="section_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., Section A">
            </div>
            <div>
                <label>Batch Year *:</label>
                <select name="batch_year" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select Batch Year</option>
                    {% for batch in batch_years %}
                        <option value="{{ batch }}">{{ batch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Class Teacher:</label>
                <select name="class_teacher" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select Class Teacher</option>
                    {% for teacher in faculty %}
                        <option value="{{ teacher.username }}">{{ teacher.name }} ({{ teacher.designation }})</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Student Range Start:</label>
                <input type="text" name="student_range_start" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., AR31001">
            </div>
            <div>
                <label>Student Range End:</label>
                <input type="text" name="student_range_end" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., AR31008">
            </div>
        </div>
        <button type="submit" style="margin-top: 15px; padding: 12px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
            🚀 Create Section
        </button>
    </form>
</div>

<!-- AUTO ASSIGNMENT -->
<div style="background: #e8f4fd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #3498db;">
    <h4 style="color: #2c3e50; margin-bottom: 15px;">🤖 Auto-Assign Students to Sections</h4>
    <div style="display: flex; gap: 15px; align-items: end;">
        <div style="flex: 1;">
            <label>Select Batch Year:</label>
            <select id="autoAssignBatch" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Select Batch Year</option>
                {% for batch in batch_years %}
                    <option value="{{ batch }}">{{ batch }}</option>
                {% endfor %}
            </select>
        </div>
        <button onclick="autoAssignStudents()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
            🤖 Auto-Assign Students
        </button>
    </div>
    <small style="color: #7f8c8d; display: block; margin-top: 10px;">
        This will automatically assign students to sections based on the roll number ranges you defined above.
    </small>
</div>

<!-- MENTOR ASSIGNMENT -->
<div style="background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #9b59b6; padding-bottom: 10px;">👥 Assign Mentors</h3>
    <form id="assignMentorForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <label>Select Mentor *:</label>
                <select name="mentor_id" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select Mentor</option>
                    {% for teacher in faculty %}
                        <option value="{{ teacher.username }}">{{ teacher.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Batch Year *:</label>
                <select name="batch_year" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Select Batch Year</option>
                    {% for batch in batch_years %}
                        <option value="{{ batch }}">{{ batch }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Student Range Start *:</label>
                <input type="text" name="student_range_start" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., AR31001">
            </div>
            <div>
                <label>Student Range End *:</label>
                <input type="text" name="student_range_end" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., AR31004">
            </div>
        </div>
        <button type="submit" style="margin-top: 15px; padding: 12px 30px; background: #9b59b6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
            👥 Assign Mentor
        </button>
    </form>
</div>

<!-- EXISTING SECTIONS -->
<div style="background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3>🏫 Existing Sections ({{ sections|length }})</h3>
    
    {% if sections %}
    <div style="overflow-x: auto; margin-top: 20px;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #34495e; color: white;">
                    <th style="padding: 12px; text-align: left;">Section ID</th>
                    <th style="padding: 12px; text-align: left;">Section Name</th>
                    <th style="padding: 12px; text-align: left;">Batch Year</th>
                    <th style="padding: 12px; text-align: left;">Class Teacher</th>
                    <th style="padding: 12px; text-align: left;">Student Range</th>
                    <th style="padding: 12px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for section in sections %}
                <tr style="border-bottom: 1px solid #ecf0f1;">
                    <td style="padding: 12px;"><strong>{{ section.section_id }}</strong></td>
                    <td style="padding: 12px;">{{ section.section_name }}</td>
                    <td style="padding: 12px;">{{ section.batch_year }}</td>
                    <td style="padding: 12px;">{{ section.class_teacher_name or 'Not Assigned' }}</td>
                    <td style="padding: 12px;">
                        {% if section.student_range_start and section.student_range_end %}
                            {{ section.student_range_start }} - {{ section.student_range_end }}
                        {% else %}
                            Not Set
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editSection('{{ section.section_id }}')" 
                                style="padding: 6px 12px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            ✏️ Edit
                        </button>
                        <button onclick="deleteSection('{{ section.section_id }}')" 
                                style="padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            🗑️ Delete
                        </button>
                        <button onclick="viewSectionStudents('{{ section.section_id }}')" 
                                style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            👁️ View Students
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
        <div style="font-size: 48px; margin-bottom: 20px;">🏫</div>
        <h4 style="color: #95a5a6;">No Sections Created</h4>
        <p>Create your first section using the form above.</p>
    </div>
    {% endif %}
</div>

<!-- MENTOR ASSIGNMENTS SUMMARY -->
<div style="background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3>👥 Current Mentor Assignments</h3>
    <div style="margin-bottom: 15px;">
        <label>Filter by Batch Year:</label>
        <select id="mentorBatchFilter" onchange="loadMentorAssignments()" style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-left: 10px;">
            <option value="">All Batches</option>
            {% for batch in batch_years %}
                <option value="{{ batch }}">{{ batch }}</option>
            {% endfor %}
        </select>
    </div>
    <div id="mentorAssignmentsContainer">
        <!-- Mentor assignments will be loaded here -->
    </div>
</div>

<!-- MODALS -->
<!-- Edit Section Modal -->
<div id="editSectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <h3>✏️ Edit Section</h3>
        <div id="editSectionFormContainer">
            <!-- Edit form will be loaded here -->
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="closeEditSectionModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                Cancel
            </button>
            <button onclick="saveSectionChanges()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                💾 Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Section Students Modal -->
<div id="sectionStudentsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <h3>🎓 Students in Section</h3>
        <div id="sectionStudentsContainer">
            <!-- Students list will be loaded here -->
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="closeSectionStudentsModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>
</div>

<script>
// ========== SECTION MANAGEMENT ==========
document.getElementById('addSectionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const sectionData = {
        section_name: formData.get('section_name'),
        batch_year: formData.get('batch_year'),
        class_teacher: formData.get('class_teacher') || null,
        student_range_start: formData.get('student_range_start') || null,
        student_range_end: formData.get('student_range_end') || null
    };
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '⏳ Creating Section...';
    submitBtn.disabled = true;
    
    fetch('/hod/add-section', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(sectionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Section created successfully!');
            this.reset();
            location.reload();
        } else {
            alert('❌ Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// ========== MENTOR ASSIGNMENT ==========
document.getElementById('assignMentorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mentorData = {
        mentor_id: formData.get('mentor_id'),
        batch_year: formData.get('batch_year'),
        student_range_start: formData.get('student_range_start'),
        student_range_end: formData.get('student_range_end')
    };
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '⏳ Assigning Mentor...';
    submitBtn.disabled = true;
    
    fetch('/hod/assign-mentor', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(mentorData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            this.reset();
            loadMentorAssignments(); // Refresh mentor assignments
        } else {
            alert('❌ Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// ========== AUTO ASSIGNMENT ==========
function autoAssignStudents() {
    const batchYear = document.getElementById('autoAssignBatch').value;
    
    if (!batchYear) {
        alert('❌ Please select a batch year');
        return;
    }
    
    if (!confirm(`Auto-assign students for batch ${batchYear}? This will assign students based on roll number ranges.`)) {
        return;
    }
    
    fetch('/hod/auto-assign-students', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ batch_year: batchYear })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
        } else {
            alert('❌ Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}

// ========== MENTOR ASSIGNMENTS DISPLAY ==========
function loadMentorAssignments() {
    const batchYear = document.getElementById('mentorBatchFilter').value;
    
    fetch('/hod/get-mentor-assignments?batch_year=' + (batchYear || ''))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMentorAssignments(data.assignments);
        } else {
            document.getElementById('mentorAssignmentsContainer').innerHTML = 
                '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Error loading mentor assignments</p>';
        }
    })
    .catch(error => {
        document.getElementById('mentorAssignmentsContainer').innerHTML = 
            '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Error loading mentor assignments</p>';
    });
}

function displayMentorAssignments(assignments) {
    const container = document.getElementById('mentorAssignmentsContainer');
    
    if (assignments.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                <div style="font-size: 48px; margin-bottom: 20px;">👥</div>
                <h4 style="color: #95a5a6;">No Mentor Assignments</h4>
                <p>Assign mentors using the form above.</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #34495e; color: white;">
                        <th style="padding: 12px; text-align: left;">Mentor</th>
                        <th style="padding: 12px; text-align: left;">Student Range</th>
                        <th style="padding: 12px; text-align: center;">Student Count</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    assignments.forEach(assignment => {
        html += `
            <tr style="border-bottom: 1px solid #ecf0f1;">
                <td style="padding: 12px;">${assignment.mentor_name}</td>
                <td style="padding: 12px;">${assignment.range_start} - ${assignment.range_end}</td>
                <td style="padding: 12px; text-align: center;">
                    <span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                        ${assignment.student_count} students
                    </span>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// ========== SECTION OPERATIONS ==========

function editStudentSection(studentId) {
    currentEditStudentId = studentId;
    
    // Get available faculty for mentor selection
    fetch('/hod/get-faculty-for-section')
    .then(response => response.json())
    .then(data => {
        let facultyOptions = '<option value="">No Mentor</option>';
        if (data.success) {
            data.faculty.forEach(faculty => {
                facultyOptions += `<option value="${faculty.username}">${faculty.name}</option>`;
            });
        }
        
        const formHTML = `
            <form id="editSectionForm">
                <div style="margin-bottom: 15px;">
                    <label>Section:</label>
                    <select name="section_id" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">No Section</option>
                        {% for section in sections %}
                            <option value="{{ section.section_id }}">{{ section.section_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Mentor (Class Teacher):</label>
                    <select name="mentor_id" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        ${facultyOptions}
                    </select>
                </div>
            </form>
        `;
        
        document.getElementById('editSectionFormContainer').innerHTML = formHTML;
        document.getElementById('editSectionModal').style.display = 'flex';
    })
    .catch(error => {
        alert('❌ Error loading faculty data: ' + error);
    });
}
let currentEditSectionId = null;

function editSection(sectionId) {
    currentEditSectionId = sectionId;
    
    // Find the section data from the table
    const sections = {{ sections|tojson }};
    const section = sections.find(s => s.section_id === sectionId);
    
    if (section) {
        const editForm = `
            <form id="editSectionForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label>Section Name *:</label>
                        <input type="text" name="section_name" value="${section.section_name}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label>Batch Year *:</label>
                        <select name="batch_year" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Select Batch Year</option>
                            {% for batch in batch_years %}
                                <option value="{{ batch }}" ${section.batch_year === '{{ batch }}' ? 'selected' : ''}>{{ batch }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label>Class Teacher:</label>
                        <select name="class_teacher" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Select Class Teacher</option>
                            {% for teacher in faculty %}
                                <option value="{{ teacher.username }}" ${section.class_teacher === '{{ teacher.username }}' ? 'selected' : ''}>{{ teacher.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label>Student Range Start:</label>
                        <input type="text" name="student_range_start" value="${section.student_range_start || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., AR31001">
                    </div>
                    <div>
                        <label>Student Range End:</label>
                        <input type="text" name="student_range_end" value="${section.student_range_end || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., AR31008">
                    </div>
                </div>
            </form>
        `;
        
        document.getElementById('editSectionFormContainer').innerHTML = editForm;
        document.getElementById('editSectionModal').style.display = 'flex';
    }
}

function saveSectionChanges() {
    const formData = new FormData(document.getElementById('editSectionForm'));
    const sectionData = {
        section_name: formData.get('section_name'),
        batch_year: formData.get('batch_year'),
        class_teacher: formData.get('class_teacher') || null,
        student_range_start: formData.get('student_range_start') || null,
        student_range_end: formData.get('student_range_end') || null
    };
    
    fetch('/hod/update-section/' + currentEditSectionId, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(sectionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Section updated successfully!');
            closeEditSectionModal();
            location.reload();
        } else {
            alert('❌ Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}

function deleteSection(sectionId) {
    if (confirm('Are you sure you want to delete this section? Students will be unassigned from this section.')) {
        fetch('/hod/delete-section/' + sectionId, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Section deleted successfully!');
                location.reload();
            } else {
                alert('❌ Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('❌ Network error: ' + error);
        });
    }
}

function viewSectionStudents(sectionId) {
    fetch('/hod/get-section-students/' + sectionId)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySectionStudents(data.students, data.section_name);
        } else {
            alert('❌ Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('❌ Network error: ' + error);
    });
}

function displaySectionStudents(students, sectionName) {
    let html = `<h4>${sectionName} - ${students.length} Students</h4>`;
    
    if (students.length === 0) {
        html += '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No students assigned to this section.</p>';
    } else {
        html += `
            <div style="overflow-x: auto; max-height: 400px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #34495e; color: white;">
                            <th style="padding: 10px; text-align: left;">Student ID</th>
                            <th style="padding: 10px; text-align: left;">Name</th>
                            <th style="padding: 10px; text-align: left;">Mentor</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        students.forEach(student => {
            html += `
                <tr style="border-bottom: 1px solid #ecf0f1;">
                    <td style="padding: 10px;">${student.student_id}</td>
                    <td style="padding: 10px;">${student.name}</td>
                    <td style="padding: 10px;">${student.mentor_name || 'Not Assigned'}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    document.getElementById('sectionStudentsContainer').innerHTML = html;
    document.getElementById('sectionStudentsModal').style.display = 'flex';
}

function closeEditSectionModal() {
    document.getElementById('editSectionModal').style.display = 'none';
    currentEditSectionId = null;
}

function closeSectionStudentsModal() {
    document.getElementById('sectionStudentsModal').style.display = 'none';
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    // Load initial mentor assignments
    loadMentorAssignments();
});
</script>
{% endblock %}